<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --bg-light: #f1f5f9; }
        body { background-color: var(--bg-light); font-family: 'Sarabun', sans-serif; }
        .time-bar { background: #0f172a; color: white; padding: 10px 0; font-size: 0.9rem; }
        
        .zone-btn {
            display: block; width: 100%; padding: 15px; border-radius: 12px;
            background: white; border: 2px solid transparent; 
            text-align: center; text-decoration: none; color: #64748b; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .zone-btn:hover { transform: translateY(-3px); }
        .zone-btn.active-food { background: #fff7ed; border-color: #f97316; color: #ea580c; }
        .zone-btn.active-fashion { background: #fdf2f8; border-color: #db2777; color: #be185d; }
        .zone-btn.active-it { background: #eff6ff; border-color: #2563eb; color: #1d4ed8; }

        .stall-card {
            height: 140px; border-radius: 12px; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: white; border: 2px dashed #cbd5e1; color: #94a3b8;
        }
        .stall-card:hover { border-color: var(--primary); background: #f0f9ff; color: var(--primary); }
        .stall-card.booked { background: #fff1f2; border: 1px solid #fda4af; color: #e11d48; }
        .booked-badge { position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; font-size: 0.6rem; padding: 2px 8px; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="time-bar sticky-top shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
           <div class="d-flex align-items-center gap-2">
    {% if info.status == 'OPEN' %}
        <span class="badge bg-success">OPEN</span>
    {% else %}
        <span class="badge bg-secondary">CLOSED</span>
    {% endif %}
    <small class="d-none d-md-inline">‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏•‡∏≤‡∏î 11:00 - 00:00</small>
    <span class="opacity-50">|</span>
    <small id="live-clock" class="fw-bold text-warning"></small>
</div>
            
            <div class="d-flex align-items-center gap-3">
                {% if session.get('user_id') %}
                    <a href="/topup" class="btn btn-sm btn-success rounded-pill px-2 py-0 fw-bold border-0" style="font-size: 0.8rem;">
                        <i class="fas fa-plus-circle"></i> ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô
                    </a>
                    
                    <span class="text-warning small fw-bold"><i class="fas fa-wallet"></i> {{ user_info.credit }} ‡∏ø</span>
                    <div class="dropdown">
                        <a href="#" class="text-white text-decoration-none dropdown-toggle fw-bold" data-bs-toggle="dropdown">
                            {{ session['username'] }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            {% if session['role'] == 'admin' %}
                                <li><a class="dropdown-item fw-bold text-primary" href="/admin"><i class="fas fa-cogs"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</a></li>
                                <li><hr class="dropdown-divider"></li>
                            {% endif %}
                            <li><a class="dropdown-item text-danger" href="/logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a></li>
                        </ul>
                    </div>
                {% else %}
                    <a href="/login" class="text-white text-decoration-none fw-bold small">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container py-4">
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show rounded-4">{{ message }} <button class="btn-close" data-bs-dismiss="alert"></button></div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row g-3 mb-4">
            <div class="col-4"><a href="/?zone=Food Court" class="zone-btn {{ 'active-food' if active_zone == 'Food Court' }}"><i class="fas fa-utensils"></i> Food</a></div>
            <div class="col-4"><a href="/?zone=Fashion Street" class="zone-btn {{ 'active-fashion' if active_zone == 'Fashion Street' }}"><i class="fas fa-tshirt"></i> Fashion</a></div>
            <div class="col-4"><a href="/?zone=IT Zone" class="zone-btn {{ 'active-it' if active_zone == 'IT Zone' }}"><i class="fas fa-mobile-alt"></i> IT Zone</a></div>
        </div>

        <div class="row g-4">
            <div class="col-lg-9">
                <div class="card border-0 shadow-sm p-4 rounded-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold text-secondary m-0">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: {{ active_zone }}</h5>
                        <small class="text-muted"><i class="fas fa-info-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô {{ info.cancel_deadline_str }}</small>
                    </div>
                    
                    {% for zone_name, items in zones.items() %}
                    <div class="{{ 'd-block' if zone_name == active_zone else 'd-none' }}">
                        <div class="row g-3">
                            {% for stall in items %}
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="stall-card {{ 'booked' if stall.status == 'booked' else 'free' }}"
                                     onclick="openBooking('{{ stall.id }}', '{{ stall.name }}', '{{ stall.price }}', '{{ stall.status }}', '{{ stall.shop_name }}', '{{ zone_name }}', '{{ stall.booked_by }}')">
                                    
                                    {% if stall.status == 'booked' %}
                                        <span class="booked-badge">‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                                        <h6 class="fw-bold m-0 mt-3 text-truncate w-75 text-center">{{ stall.shop_name }}</h6>
                                        <small class="text-muted">‡∏•‡πá‡∏≠‡∏Ñ {{ stall.name }}</small>
                                    {% else %}
                                        <i class="fas fa-plus fs-3 mb-2 opacity-50"></i>
                                        <h6 class="fw-bold m-0">{{ stall.name }}</h6>
                                        <small>{{ stall.price }} ‡∏ø</small>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="col-lg-3">
                <div class="card border-0 shadow-sm p-3 text-center mb-3 rounded-4">
                    <h6 class="text-uppercase text-muted fw-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</h6>
                    <h1 class="text-warning fw-bold">{{ avg_rating }}</h1>
                    <button class="btn btn-outline-dark w-100 rounded-pill btn-sm" data-bs-toggle="modal" data-bs-target="#reviewModal">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
                </div>
                <div class="card border-0 shadow-sm p-3 rounded-4 bg-white" style="max-height: 400px; overflow-y: auto;">
                    <h6 class="fw-bold mb-3">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                    {% for review in reviews %}
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <strong class="text-primary small">{{ review.shop_name }}</strong>
                            <span class="text-warning small">{{ review.rating }}‚òÖ</span>
                        </div>
                        <p class="small text-muted mb-0">"{{ review.comment }}"</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">‡∏à‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Ñ: <span id="mName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0">
                    <form action="/book" method="POST">
                        <input type="hidden" name="stall_id" id="mId">
                        <input type="hidden" name="current_zone" id="mZone">

                        <div id="viewAvailable" class="d-none">
                            <h3 class="text-center text-primary fw-bold mb-3"><span id="mPrice"></span> ‡∏ö‡∏≤‡∏ó</h3>
                            
                            {% if session.get('user_id') %}
                                <div class="mb-3"><input type="text" name="shop_name" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" required></div>
                                <div class="row g-2 mb-3">
                                    <div class="col-6"><input type="tel" name="phone" class="form-control" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" required></div>
                                    <div class="col-6">
                                        <select name="category" class="form-select" required>
                                            <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                            <option value="‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤</option>
                                            <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ">‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="bg-light p-3 rounded-3 mb-3">
                                    <label class="fw-bold small mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="payment_method" id="payTransfer" value="transfer" checked onclick="togglePayment('transfer')">
                                        <label class="form-check-label" for="payTransfer">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô / QR Code</label>
                                    </div>
                                    <div id="qrArea" class="text-center bg-white p-2 rounded border mb-2">
                                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=0812345678" class="mb-2">
                                        <div class="small text-muted">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå: 081-234-5678</div>
                                        <input type="text" name="payment_ref" class="form-control form-control-sm mt-2" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏•‡∏¥‡∏õ / ‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏≠‡∏ô">
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method" id="payCredit" value="credit" onclick="togglePayment('credit')">
                                        <label class="form-check-label" for="payCredit">‡∏ï‡∏±‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï ({{ user_info.credit if user_info else 0 }} ‡∏ø)</label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                            {% else %}
                                <div class="text-center"><a href="/login" class="btn btn-primary rounded-pill px-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></div>
                            {% endif %}
                        </div>

                        <div id="viewBooked" class="d-none text-center">
                            <div class="alert alert-danger">‡∏•‡πá‡∏≠‡∏Ñ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
                            <h5 class="fw-bold" id="mShopName"></h5>
                            
                            <div id="ownerPanel" class="d-none mt-3">
                                {% if info.can_cancel %}
                                    <a href="#" id="btnCancel" class="btn btn-outline-danger w-100 rounded-pill">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)</a>
                                    <small class="text-muted d-block mt-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô {{ info.cancel_deadline_str }}</small>
                                {% else %}
                                    <div class="alert alert-secondary small">
                                        <i class="fas fa-clock"></i> ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö {{ info.cancel_deadline_str }})
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content rounded-4 p-3">
                <h5 class="text-center fw-bold">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</h5>
                <form action="/review" method="POST">
                    <input type="text" name="shop_name" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" required>
                    <select name="rating" class="form-select mb-2">
                        <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                        <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ</option>
                        <option value="3">‚òÖ‚òÖ‚òÖ</option>
                    </select>
                    <textarea name="comment" class="form-control mb-3" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..."></textarea>
                    <button type="submit" class="btn btn-dark w-100 rounded-pill">‡∏™‡πà‡∏á</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 3] ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á (Real-time)
        function updateThaiTime() {
            const date = new Date();
            const options = { 
                timeZone: 'Asia/Bangkok', 
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                day: 'numeric', month: 'short', year: 'numeric'
            };
            const thaiTime = date.toLocaleString('th-TH', options);
            document.getElementById('live-clock').innerText = "üïí " + thaiTime;
        }
        setInterval(updateThaiTime, 1000);
        updateThaiTime(); // ‡∏£‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö

        function togglePayment(method) {
            document.getElementById('qrArea').classList.toggle('d-none', method !== 'transfer');
        }

        function openBooking(id, name, price, status, shopName, zone, bookedBy) {
            document.getElementById('mId').value = id;
            document.getElementById('mName').innerText = name;
            document.getElementById('mPrice').innerText = price;
            document.getElementById('mZone').value = zone;
            
            const viewAvail = document.getElementById('viewAvailable');
            const viewBooked = document.getElementById('viewBooked');
            const ownerPanel = document.getElementById('ownerPanel');
            const currentUserId = {{ session.get('user_id') or 'null' }};
            const isAdmin = {{ 'true' if session.get('role') == 'admin' else 'false' }};

            if (status === 'booked') {
                viewAvail.classList.add('d-none');
                viewBooked.classList.remove('d-none');
                document.getElementById('mShopName').innerText = shopName;
                
                if (currentUserId == bookedBy || isAdmin) {
                    ownerPanel.classList.remove('d-none');
                    const btn = document.getElementById('btnCancel');
                    if(btn) btn.href = "/cancel_booking/" + id;
                } else {
                    ownerPanel.classList.add('d-none');
                }
            } else {
                viewAvail.classList.remove('d-none');
                viewBooked.classList.add('d-none');
                document.getElementById('payTransfer').checked = true;
                togglePayment('transfer');
            }
            new bootstrap.Modal(document.getElementById('bookingModal')).show();
        }
    </script>
</body>
</html>

